    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org">
    <head>
        <title>Danh sách Approved Applications</title>
        <meta charset="UTF-8"/>
        <!-- Bootstrap 5 CSS (giả sử bạn đã import sẵn ở layout) -->
        <link
                rel="stylesheet"
                href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
        >
    </head>
    <body>

    <div class="container mt-4">

        <h1>Danh sách Approved Applications</h1>

        <!-- FORM LỌC -->
        <form th:action="@{/approved-applications}" method="get" class="row g-3">
            <!-- Input CSRF token -->
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="col-auto">
                <label for="applicationId">Application ID:</label>
                <input type="number" id="applicationId" name="applicationId" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="submissionDate">Submission Date:</label>
                <input type="date" id="submissionDate" name="submissionDate" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="approvalDate">Approval Date:</label>
                <input type="date" id="approvalDate" name="approvalDate" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="dormitoryArea">Dormitory Area:</label>
                <input type="text" id="dormitoryArea" name="dormitoryArea" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="department">Department:</label>
                <input type="text" id="department" name="department" class="form-control" />
            </div>
            <div class="col-auto align-self-end">
                <button type="submit" class="btn btn-primary">Tìm kiếm</button>
            </div>
        </form>

        <hr/>

        <!-- NÚT XẾP PHÒNG -->
        <!-- Khi click -> mở modal chọn phòng. -->
        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#assignRoomModal">
            Xếp phòng
        </button>

        <!-- HIỂN THỊ DANH SÁCH KẾT QUẢ -->
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Select</th>
                <th>Application ID</th>
                <th>Submission Date</th>
                <th>Approval Date</th>
                <th>Dormitory Area</th>
                <th>Full Name</th>
                <th>Address</th>
                <th>Department</th>
                <th>Phone Number</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="app : ${applicationList}">
                <!-- Checkbox -->
                <td>
                    <input type="checkbox"
                           name="selectedApps"
                           th:value="${app.applicationId}"
                           class="form-check-input chk-app" />
                </td>
                <td th:text="${app.applicationId}">1</td>
                <td th:text="${app.submissionDate}">2023-01-01</td>
                <td th:text="${app.approvalDate}">2023-02-01</td>
                <td th:text="${app.dormitoryArea}">Dorm A</td>
                <td th:text="${app.fullName}">Nguyen Van A</td>
                <td th:text="${app.address}">123 ABC St</td>
                <td th:text="${app.department}">Computer Science</td>
                <td th:text="${app.phoneNumber}">123456789</td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL CHỌN PHÒNG -->
    <div class="modal fade" id="assignRoomModal" tabindex="-1" aria-labelledby="assignRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="assignRoomModalLabel">Chọn phòng để xếp</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Hiển thị danh sách phòng bằng <select> hoặc <table> -->
                    <label for="roomSelect" class="form-label">Danh sách phòng</label>
                    <select id="roomSelect" class="form-select">
                        <!-- Giả sử bạn load sẵn list RoomList từ backend -->
                        <option th:each="room : ${roomList}"
                                th:value="${room.roomId}"
                                th:text="${room.roomNumber + ' - ' + room.dormName}">
                            <!-- "Phòng 101 - KTX A" -->
                        </option>

                    </select>

                    <div id="errorMsg" class="text-danger mt-2" style="display: none;"></div>
                    <div id="successMsg" class="text-success mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAssignRoom()">Xác nhận xếp phòng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS + Popper (nếu chưa có) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Lưu giá trị form vào Local Storage trước khi submit
        document.querySelector('form').addEventListener('submit', function () {
            const formData = new FormData(this);
            for (let [key, value] of formData.entries()) {
                localStorage.setItem(key, value); // Lưu từng cặp key-value
            }
        });

        // Khôi phục giá trị form từ Local Storage khi trang được tải
        window.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('input, select').forEach(input => {
                const value = localStorage.getItem(input.name); // Lấy giá trị theo key
                if (value) {
                    input.value = value; // Gán giá trị cho input
                }
            });
        });

        // Xoá giá trị trong Local Storage khi cần (nếu có nút reset)
        document.querySelector('form').addEventListener('reset', function () {
            localStorage.clear(); // Xoá toàn bộ dữ liệu trong Local Storage
        });
    </script>


    <script>
        // Hàm lấy danh sách applicationId đã chọn và gọi API xếp phòng
        function confirmAssignRoom() {
            let checkboxes = document.querySelectorAll('.chk-app:checked');
            if (checkboxes.length === 0) {
                alert("Bạn chưa chọn sinh viên nào!");
                return;
            }
            let selectedAppIds = Array.from(checkboxes).map(cb => cb.value);

            let roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert("Bạn chưa chọn phòng!");
                return;
            }

            // Gọi API /assign-room bằng fetch (POST)
            // payload: JSON { applicationIds: [...], roomId: ... }
            fetch('/assign-room', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRF-Token': document.querySelector('input[name=_csrf]').value // Lấy token từ input hidden
                },
                body: JSON.stringify({
                    applicationIds: selectedAppIds,
                    roomId: parseInt(roomId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Thành công
                    document.getElementById('errorMsg').style.display = 'none';
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('successMsg').innerText = data.message;
                    // Sau 1 lúc có thể reload page:
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    // Thất bại -> Hiển thị lỗi
                    document.getElementById('successMsg').style.display = 'none';
                    document.getElementById('errorMsg').style.display = 'block';
                    document.getElementById('errorMsg').innerText = data.message;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Có lỗi xảy ra khi xếp phòng!");
            });
        }
    </script>

    </body>
    </html>
