<!-- src/main/resources/templates/manager/application/approved_application_list.html-->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/manager/layout}">

<head>
    <title layout:fragment="title">Danh sách Approved Applications</title>
    <meta charset="UTF-8"/>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />


</head>

<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h1>Danh sách Approved Applications</h1>

        <!-- FORM LỌC -->
        <form th:action="@{/approved-applications}" method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div>
                <label for="applicationId" class="block text-sm font-medium text-gray-700">Application ID:</label>
                <input type="number" id="applicationId" name="applicationId" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div>
                <label for="submissionDate" class="block text-sm font-medium text-gray-700">Submission Date:</label>
                <input type="date" id="submissionDate" name="submissionDate" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div>
                <label for="approvalDate" class="block text-sm font-medium text-gray-700">Approval Date:</label>
                <input type="date" id="approvalDate" name="approvalDate" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div>
                <label for="dormitoryArea" class="block text-sm font-medium text-gray-700">Dormitory Area:</label>
                <input type="text" id="dormitoryArea" name="dormitoryArea" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div>
                <label for="address" class="block text-sm font-medium text-gray-700">Address:</label>
                <input type="text" id="address" name="address" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div>
                <label for="department" class="block text-sm font-medium text-gray-700">Department:</label>
                <input type="text" id="department" name="department" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2" />
            </div>
            <div class="md:col-span-3">
                <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Tìm kiếm</button>
            </div>
        </form>

        <hr/>

        <!-- NÚT XẾP PHÒNG -->
        <button class="bg-green-500 text-white px-4 py-2 rounded mb-3 hover:bg-green-600" onclick="openModal()">Xếp phòng</button>

        <!-- HIỂN THỊ DANH SÁCH KẾT QUẢ -->
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
            <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Select</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Application ID</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submission Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approval Date</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dormitory Area</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Full Name</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
            </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
            <tr th:each="app : ${applicationList}">
                <td class="px-6 py-4 whitespace-nowrap">
                    <input type="checkbox" name="selectedApps" th:value="${app.applicationId}" class="h-4 w-4 text-blue-600 border-gray-300 rounded chk-app" />
                </td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.applicationId}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.submissionDate}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.approvalDate}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.dormitoryArea}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.fullName}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.address}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.department}"></td>
                <td class="px-6 py-4 whitespace-nowrap" th:text="${app.phoneNumber}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL CHỌN PHÒNG -->
    <div id="assignRoomModal" class="fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-50 hidden">
        <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-md">
            <h1 class="text-lg font-bold mb-4">Chọn phòng để xếp</h1>
            <div>
                <label for="roomSelect" class="block text-sm font-medium text-gray-700">Danh sách phòng</label>
                <select id="roomSelect" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                    <option th:each="room : ${roomList}" th:value="${room.roomId}" th:text="${room.roomNumber + ' - ' + room.dormName}"></option>
                </select>
                <div id="errorMsg" class="text-red-500 mt-2 hidden"></div>
                <div id="successMsg" class="text-green-500 mt-2 hidden"></div>
            </div>
            <div class="mt-4 flex justify-end">
                <button type="button" class="bg-gray-500 text-white px-4 py-2 rounded mr-2 hover:bg-gray-600" onclick="closeModal()">Đóng</button>
                <button type="button" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600" onclick="confirmAssignRoom()">Xác nhận xếp phòng</button>
            </div>
        </div>
    </div>
    <script layout:fragment="script">
        function openModal() {
            document.getElementById('assignRoomModal').classList.remove('hidden');
        }
        function closeModal() {
            document.getElementById('assignRoomModal').classList.add('hidden');
        }
        window.confirmAssignRoom = function() {
            let checkboxes = document.querySelectorAll('.chk-app:checked');
            if (checkboxes.length === 0) {
                alert("Bạn chưa chọn sinh viên nào!");
                return;
            }
            let selectedAppIds = Array.from(checkboxes).map(cb => cb.value);
            let roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert("Bạn chưa chọn phòng!");
                return;
            }
            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            fetch('/assign-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    applicationIds: selectedAppIds,
                    roomId: parseInt(roomId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('errorMsg').style.display = 'none';
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('successMsg').innerText = data.message;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    document.getElementById('successMsg').style.display = 'none';
                    document.getElementById('errorMsg').style.display = 'block';
                    document.getElementById('errorMsg').innerText = data.message;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Có lỗi xảy ra khi xếp phòng!");
            });
        }
    </script>
</div>

<!-- Bootstrap 5 JS -->



</body>
</html>
