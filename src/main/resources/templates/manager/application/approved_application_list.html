<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/manager/layout}">

<head>
    <title layout:fragment="title">Danh sách Approved Applications</title>
    <meta charset="UTF-8"/>
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />


</head>

<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <h1>Danh sách Approved Applications</h1>

        <!-- FORM LỌC -->
        <form th:action="@{/approved-applications}" method="get" class="row g-3">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <div class="col-auto">
                <label for="applicationId">Application ID:</label>
                <input type="number" id="applicationId" name="applicationId" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="submissionDate">Submission Date:</label>
                <input type="date" id="submissionDate" name="submissionDate" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="approvalDate">Approval Date:</label>
                <input type="date" id="approvalDate" name="approvalDate" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="dormitoryArea">Dormitory Area:</label>
                <input type="text" id="dormitoryArea" name="dormitoryArea" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" class="form-control" />
            </div>
            <div class="col-auto">
                <label for="department">Department:</label>
                <input type="text" id="department" name="department" class="form-control" />
            </div>
            <div class="col-auto align-self-end">
                <button type="submit" class="btn btn-primary">Tìm kiếm</button>
            </div>
        </form>

        <hr/>

        <!-- NÚT XẾP PHÒNG -->
        <button class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#assignRoomModal">
            Xếp phòng
        </button>

        <!-- HIỂN THỊ DANH SÁCH KẾT QUẢ -->
        <table class="table table-bordered">
            <thead>
            <tr>
                <th>Select</th>
                <th>Application ID</th>
                <th>Submission Date</th>
                <th>Approval Date</th>
                <th>Dormitory Area</th>
                <th>Full Name</th>
                <th>Address</th>
                <th>Department</th>
                <th>Phone Number</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="app : ${applicationList}">
                <td>
                    <input type="checkbox" name="selectedApps" th:value="${app.applicationId}" class="form-check-input chk-app" />
                </td>
                <td th:text="${app.applicationId}"></td>
                <td th:text="${app.submissionDate}"></td>
                <td th:text="${app.approvalDate}"></td>
                <td th:text="${app.dormitoryArea}"></td>
                <td th:text="${app.fullName}"></td>
                <td th:text="${app.address}"></td>
                <td th:text="${app.department}"></td>
                <td th:text="${app.phoneNumber}"></td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- MODAL CHỌN PHÒNG -->
    <div class="modal fade" id="assignRoomModal" tabindex="-1" aria-labelledby="assignRoomModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h1 class="modal-title fs-5" id="assignRoomModalLabel">Chọn phòng để xếp</h1>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <label for="roomSelect" class="form-label">Danh sách phòng</label>
                    <select id="roomSelect" class="form-select">
                        <option th:each="room : ${roomList}" th:value="${room.roomId}" th:text="${room.roomNumber + ' - ' + room.dormName}"></option>
                    </select>

                    <div id="errorMsg" class="text-danger mt-2" style="display: none;"></div>
                    <div id="successMsg" class="text-success mt-2" style="display: none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="confirmAssignRoom()">Xác nhận xếp phòng</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Đặt thẻ script chứa hàm sau phần modal -->
    <script>
        // Định nghĩa hàm confirmAssignRoom trong phạm vi global
        window.confirmAssignRoom = function() {
            let checkboxes = document.querySelectorAll('.chk-app:checked');
            if (checkboxes.length === 0) {
                alert("Bạn chưa chọn sinh viên nào!");
                return;
            }
            let selectedAppIds = Array.from(checkboxes).map(cb => cb.value);
            let roomId = document.getElementById('roomSelect').value;
            if (!roomId) {
                alert("Bạn chưa chọn phòng!");
                return;
            }

            const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

            fetch('/assign-room', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    applicationIds: selectedAppIds,
                    roomId: parseInt(roomId)
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('errorMsg').style.display = 'none';
                    document.getElementById('successMsg').style.display = 'block';
                    document.getElementById('successMsg').innerText = data.message;
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else {
                    document.getElementById('successMsg').style.display = 'none';
                    document.getElementById('errorMsg').style.display = 'block';
                    document.getElementById('errorMsg').innerText = data.message;
                }
            })
            .catch(err => {
                console.error(err);
                alert("Có lỗi xảy ra khi xếp phòng!");
            });
        }
    </script>
</div>

<!-- Bootstrap 5 JS -->



</body>
</html>
