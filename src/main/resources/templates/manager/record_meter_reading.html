<!-- src/main/resources/templates/manager/record_meter_reading.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/manager/layout}">
<head>
    <title layout:fragment="title">Ghi S·ªë ƒêi·ªán / N∆∞·ªõc</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
<div layout:fragment="content" class="mx-auto mt-4 max-w-lg">
    <h1 class="text-2xl font-bold mb-4">Ghi S·ªë ƒêi·ªán / N∆∞·ªõc</h1>

    <div th:if="${error}" class="mb-4">
        <div class="bg-red-500 text-white p-2 rounded" th:text="${error}"></div>
    </div>

    <form th:action="@{/service-usage/record}" method="post" class="space-y-4" id="meterForm">
        <!-- üè¢ Khu (Dormitory) -->
        <div>
            <label class="block text-gray-700 mb-1" for="dormId">Khu K√Ω¬†t√∫c</label>
            <select id="dormId" name="dormId" required
                    class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="">-- Ch·ªçn khu --</option>
                <option th:each="d : ${dormitories}"
                        th:value="${d.dormId}"
                        th:text="${d.dormName}"></option>
            </select>
        </div>

        <!-- üè† Ph√≤ng (s·∫Ω thay ƒë·ªïi theo khu) -->
        <div>
            <label class="block text-gray-700 mb-1" for="roomId">Ph√≤ng</label>
            <select id="roomId" name="roomId" required
                    class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="">-- Ch·ªçn ph√≤ng --</option>
                <!-- option s·∫Ω ƒë∆∞·ª£c JS th√™m v√†o -->
            </select>
        </div>

        <!-- ‚öôÔ∏è  Lo·∫°i d·ªãch v·ª• (ch·ªâ ROOM‚Äëtype) -->
        <div>
            <label class="block text-gray-700 mb-1" for="serviceId">D·ªãch v·ª•</label>
            <select id="serviceId" name="serviceId" required
                    class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="">-- Ch·ªçn d·ªãch v·ª• --</option>
                <option th:each="s : ${services}"
                        th:if="${s.serviceType == T(com.example.demo.entity.DormitoryService.ServiceType).ROOM}"
                        th:value="${s.serviceId}" th:text="${s.serviceName}"></option>
            </select>
        </div>

        <!-- üî¢ Ch·ªâ s·ªë m·ªõi -->
        <div>
            <label class="block text-gray-700 mb-1" for="currentReading">Ch·ªâ s·ªë hi·ªán t·∫°i</label>
            <input type="number" step="0.01" id="currentReading" name="currentReading" required
                   class="w-full border border-gray-300 rounded px-3 py-2">
        </div>

        <!-- üìÖ recordDate = today (·∫©n) -->
        <input type="hidden" id="recordDate" name="recordDate"
               th:value="${T(java.time.LocalDate).now()}"/>

        <button type="submit"
                class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
            üíæ Ghi S·ªë
        </button>
    </form>
</div>

<!-- --- JS --- -->
<script layout:fragment="script">
    console.log("JS loaded"); // ‚û§ ƒë·∫∑t ngay tr√™n ƒë·∫ßu <script>
  document.addEventListener('DOMContentLoaded', () => {
      // T·ª± ƒë·∫∑t recordDate = h√¥m nay (yyyy-MM-dd)
      document.getElementById('recordDate').value =
          new Date().toISOString().split('T')[0];

      // Khi ch·ªçn khu -> g·ªçi API l·∫•y ph√≤ng
      const dormSel = document.getElementById('dormId');
      const roomSel = document.getElementById('roomId');

      dormSel.addEventListener('change', async () => {
          const dormId = dormSel.value;
          roomSel.innerHTML = '<option value="">-- Ch·ªçn ph√≤ng --</option>'; // reset

          if (!dormId) return;

          try {
              const res = await fetch(`/service-usage/rooms?dormId=${dormId}`);
              const data = await res.json();

              data.forEach(r => {
                  const opt = document.createElement('option');
                  opt.value = r.roomId;
                  opt.textContent = r.roomNumber;
                  roomSel.appendChild(opt);
              });
          } catch (err) {
              alert('Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch ph√≤ng!');
          }
      });
  });
</script>
</body>
</html>
